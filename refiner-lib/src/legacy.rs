use aurora_engine::parameters::{ResultLog, SubmitResult, TransactionStatus};
use aurora_engine_types::types::RawU256;
use borsh::BorshDeserialize;
use std::io::Result;

#[derive(BorshDeserialize)]
pub struct SubmitResultLegacyV1 {
    pub status: TransactionStatus,
    pub gas_used: u64,
    pub logs: Vec<ResultLog>,
}

#[derive(BorshDeserialize)]
pub struct ResultLogV1 {
    pub topics: Vec<RawU256>,
    pub data: Vec<u8>,
}

impl Into<ResultLog> for ResultLogV1 {
    fn into(self) -> ResultLog {
        ResultLog {
            address: Default::default(),
            topics: self.topics,
            data: self.data,
        }
    }
}

impl Into<SubmitResult> for SubmitResultLegacyV1 {
    fn into(self) -> SubmitResult {
        SubmitResult::new(self.status, self.gas_used, self.logs)
    }
}

#[derive(BorshDeserialize)]
pub struct SubmitResultLegacyV2 {
    pub status: TransactionStatus,
    pub gas_used: u64,
    pub logs: Vec<ResultLogV1>,
}

impl Into<SubmitResult> for SubmitResultLegacyV2 {
    fn into(self) -> SubmitResult {
        SubmitResult::new(
            self.status,
            self.gas_used,
            self.logs.into_iter().map(Into::into).collect(),
        )
    }
}

pub fn decode_submit_result(result: &[u8]) -> Result<SubmitResult> {
    SubmitResult::try_from_slice(result)
        .or_else(|_| SubmitResultLegacyV1::try_from_slice(result).map(Into::into))
        .or_else(|_| SubmitResultLegacyV2::try_from_slice(result).map(Into::into))
}

#[cfg(test)]
mod tests {
    use super::decode_submit_result;

    #[test]
    fn test_legacy_v2() {
        let data = vec![
            0, 128, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 56, 116, 63, 29, 248, 67, 111, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 93, 154, 79, 251, 77, 90, 248, 222, 218, 123, 108,
            150, 1, 0, 0, 0, 0, 0, 5, 0, 0, 0, 2, 0, 0, 0, 225, 255, 252, 196, 146, 61, 4, 181, 89,
            244, 210, 154, 139, 252, 108, 218, 4, 235, 91, 13, 60, 70, 7, 81, 194, 64, 44, 92, 92,
            201, 16, 156, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 44, 180, 94, 219, 69, 23, 213, 148,
            122, 253, 227, 190, 171, 249, 90, 88, 37, 6, 133, 139, 32, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 56, 116, 63, 29, 248, 67, 111,
            3, 0, 0, 0, 221, 242, 82, 173, 27, 226, 200, 155, 105, 194, 176, 104, 252, 55, 141,
            170, 149, 43, 167, 241, 99, 196, 161, 22, 40, 245, 90, 77, 245, 35, 179, 239, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 44, 180, 94, 219, 69, 23, 213, 148, 122, 253, 227, 190, 171,
            249, 90, 88, 37, 6, 133, 139, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 99, 218, 77, 182,
            239, 78, 124, 98, 22, 138, 176, 57, 130, 57, 159, 149, 136, 252, 209, 152, 32, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 56, 116, 63,
            29, 248, 67, 111, 3, 0, 0, 0, 221, 242, 82, 173, 27, 226, 200, 155, 105, 194, 176, 104,
            252, 55, 141, 170, 149, 43, 167, 241, 99, 196, 161, 22, 40, 245, 90, 77, 245, 35, 179,
            239, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 99, 218, 77, 182, 239, 78, 124, 98, 22, 138,
            176, 57, 130, 57, 159, 149, 136, 252, 209, 152, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            188, 20, 67, 196, 112, 198, 19, 14, 209, 5, 39, 72, 225, 121, 253, 49, 62, 95, 32, 244,
            32, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 4, 93, 154,
            79, 251, 77, 90, 248, 222, 218, 123, 1, 0, 0, 0, 28, 65, 30, 154, 150, 224, 113, 36,
            28, 47, 33, 247, 114, 107, 23, 174, 137, 227, 202, 180, 199, 139, 229, 14, 6, 43, 3,
            169, 255, 251, 186, 209, 64, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 18, 145, 110, 142, 189, 165, 239, 163, 83, 72, 238, 98, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 239, 156, 232, 99, 35, 227, 34,
            176, 3, 0, 0, 0, 215, 138, 217, 95, 164, 108, 153, 75, 101, 81, 208, 218, 133, 252, 39,
            95, 230, 19, 206, 55, 101, 127, 184, 213, 227, 209, 48, 132, 1, 89, 216, 34, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 44, 180, 94, 219, 69, 23, 213, 148, 122, 253, 227, 190, 171,
            249, 90, 88, 37, 6, 133, 139, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 188, 20, 67, 196,
            112, 198, 19, 14, 209, 5, 39, 72, 225, 121, 253, 49, 62, 95, 32, 244, 128, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 56,
            116, 63, 29, 248, 67, 111, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 4, 93, 154, 79, 251, 77, 90, 248, 222, 218, 123, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        ];

        decode_submit_result(&data).unwrap();
    }
}
